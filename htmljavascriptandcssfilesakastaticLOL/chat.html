<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta property="og:description" content="SkellySKripts is a very clean and fast proxy" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/razzlerazing2/SkellyScript/refs/heads/main/IMG_3642.webp" type="image/x-icon" />
    <title>Live Chat - SKrypt</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/chat.css"> <!-- Link to the new chat specific CSS -->

    <style>
        /* Your existing theme styles - Keep these here as they modify the body background */
        body[theme="cuhs"] {
            background: url("/assets/media/background/poppingthatGTV.jpg") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }

        body[theme="cuhs2"] {
            background: url("/assets/media/background/stadning.jpg") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }

        body[theme="cuhs3"] {
            background: url("/assets/media/background/Pacificthatis.jpg") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }

        body[theme="catppuccin-frappe"] {
            background: url("/assets/media/background/skibididdy.jpg") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }

        body[theme="catppuccin-macchiato"] {
            background: url("/assets/media/background/rizzyaf.gif") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }

        body[theme="catppuccin-mocha"] {
            background: url("/assets/media/background/senkbucketup.webp") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }

        body[theme="default"] {
            background: url("/assets/media/background/canthurtmewmyogscantnerfmesandyop.png") no-repeat center center fixed;
            background-size: cover;
            --shadow: rgba(0, 0, 0, 0.01);
            --text: #cdd6f4;
        }
    </style>
</head>

<body>
    <div id="preloader">
        <div class="spinner"></div>
    </div>

    <nav class="animated-content">
        <div class="nav-container">
            <ul class="nav-links">
                <li><a href="/home"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="/games"><i class="fas fa-gamepad"></i> Games</a></li>
                <li><a href="/apps"><i class="fas fa-mobile-alt"></i> Apps</a></li>
                <li><a href="/settings"><i class="fas fa-cogs"></i> Settings</a></li>
                <li><a href="/chat.html"><i class="fas fa-comments"></i> Live Chat</a></li> <!-- New Live Chat link -->
            </ul>
        </div>
    </nav>

    <div class="container animated-content">
        <div class="overlay"></div>
        <div class="container-inner">
            <h1><span class="highlight">Live Chat</span></h1>
            <p class="chat-description">Join the conversation!</p>

            <div id="chat-messages">
                <!-- Chat messages will be appended here by JavaScript -->
                <div class="message system-message">
                    <p>Welcome to the chat! You are currently chatting as Anonymous.</p>
                </div>
            </div>

            <div class="chat-input-area">
                <input type="text" id="message-input" placeholder="Type your message..." disabled />
                <button id="send-message-button" disabled><i class="fas fa-paper-plane"></i> Send</button>
            </div>
            <div id="loading-indicator" class="hidden">Connecting to chat...</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = '';
        const username = "Anonymous"; // Default username

        // DOM elements
        const chatMessagesDiv = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendMessageButton = document.getElementById('send-message-button');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Utility Functions ---

        // Display messages in the chat interface
        function displayMessage(message, sender, senderName = '') {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', `${sender}-message`);

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (sender === 'user' || sender === 'other') {
                messageElement.innerHTML = `
                    <span class="message-header"><strong>${senderName}</strong> <span class="timestamp">${timestamp}</span></span>
                    <p>${message}</p>
                `;
            } else { // system-message
                messageElement.innerHTML = `<p>${message}</p>`;
            }
            chatMessagesDiv.appendChild(messageElement);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Auto-scroll to bottom
        }

        // --- Firebase Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                startChatListener();
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                messageInput.focus();
            } else {
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.textContent = "Signing in anonymously...";
                try {
                    // Use __initial_auth_token if available, otherwise sign in anonymously
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    displayMessage("Error: Could not connect to chat service. Please try again later.", 'system');
                    loadingIndicator.textContent = "Connection failed.";
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            }
        });

        // --- Send Message Function ---
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return; // No need to check username, it's always "Anonymous"

            messageInput.disabled = true;
            sendMessageButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.textContent = "Sending message...";

            try {
                // Add message to Firestore
                await addDoc(collection(db, `artifacts/${appId}/public/data/chat_messages`), {
                    username: username, // Uses the default "Anonymous"
                    message: messageText,
                    timestamp: serverTimestamp(), // Use server timestamp for consistent ordering
                    userId: userId // Store userId for identifying sender
                });
                messageInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error sending message:", error);
                displayMessage("Failed to send message. Please try again.", 'system');
            } finally {
                messageInput.disabled = false;
                sendMessageButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                messageInput.focus();
            }
        }

        // Event listeners for sending messages
        sendMessageButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Real-time Chat Listener ---
        function startChatListener() {
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.textContent = "Loading messages...";

            // Query messages ordered by timestamp
            const q = query(collection(db, `artifacts/${appId}/public/data/chat_messages`), orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        const sender = msg.userId === userId ? 'user' : 'other';
                        displayMessage(msg.message, sender, msg.username);
                    }
                    // You can add 'modified' and 'removed' handling if needed
                });
            }, (error) => {
                console.error("Error listening to chat messages:", error);
                displayMessage("Error loading messages. Please refresh.", 'system');
                loadingIndicator.textContent = "Error loading chat.";
            });
        }

        // --- General UI Scripts (reused from other pages) ---
        window.addEventListener('load', () => {
            const preloader = document.getElementById('preloader');
            const animatedElements = document.querySelectorAll('.animated-content');

            setTimeout(() => {
                preloader.classList.add('hidden');
                animatedElements.forEach(element => {
                    element.classList.add('show');
                });

                // --- JavaScript for Active Navigation Link ---
                const navLinks = document.querySelectorAll('.nav-links li a');
                const currentPath = window.location.pathname;

                navLinks.forEach(link => {
                    const normalizedCurrentPath = currentPath.endsWith('/') && currentPath.length > 1
                        ? currentPath.slice(0, -1)
                        : currentPath;

                    const normalizedLinkPath = link.pathname.endsWith('/') && link.pathname.length > 1
                        ? link.pathname.slice(0, -1)
                        : link.pathname;

                    if (normalizedLinkPath === normalizedCurrentPath ||
                        (normalizedLinkPath === '/home' && normalizedCurrentPath === '/')) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }, 500);
        });

        // Apply saved theme on page load
        const savedTheme = localStorage.getItem('theme') || 'cuhs3';
        document.body.setAttribute('theme', savedTheme);

        function setTheme(theme) {
            document.body.setAttribute('theme', theme);
            localStorage.setItem('theme', theme);
        }
    </script>
</body>

</html>
